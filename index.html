<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心率與血氧監測</title>
    <style>
        /* CSS 樣式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #e0f2f7; /* 淡藍色背景 */
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* 更明顯的陰影 */
            text-align: center;
            width: 90%;
            max-width: 650px;
            border: 1px solid #cce7f2; /* 輕微邊框 */
        }
        h1 {
            color: #007bff;
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 600;
        }
        .button-group {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px; /* 按鈕間距 */
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.15em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px); /* 懸停效果 */
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #disconnectButton {
            background-color: #dc3545; /* 紅色用於斷開 */
        }
        #disconnectButton:hover {
            background-color: #c82333;
        }
        .data-display {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            width: 100%;
            gap: 20px; /* 數據方塊間距 */
        }
        .data-item {
            background-color: #f0f8ff; /* 淺藍色背景 */
            padding: 20px 25px;
            border-radius: 12px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border: 1px solid #b3e0ff;
        }
        .data-item h2 {
            margin-top: 0;
            color: #007bff;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .data-item p {
            font-size: 3.2em;
            font-weight: bold;
            color: #2c3e50; /* 深灰色 */
            margin: 0;
            line-height: 1.2;
        }
        .status {
            margin-top: 25px;
            font-size: 1em;
            color: #555;
            min-height: 20px; /* 防止內容變動時跳動 */
        }

        /* RWD 調整 */
        @media (max-width: 600px) {
            .data-display {
                flex-direction: column;
                align-items: center;
            }
            .data-item {
                width: 100%;
                max-width: 300px;
            }
            .button-group {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            button {
                width: 80%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>藍牙健康監測</h1>
        <div class="button-group">
            <button id="connectButton">連接藍牙設備</button>
            <button id="disconnectButton" disabled>斷開連接</button>
        </div>
        <div class="data-display">
            <div class="data-item">
                <h2>心率 (BPM)</h2>
                <p id="heartRateValue">--</p>
            </div>
            <div class="data-item">
                <h2>血氧 (%)</h2>
                <p id="spo2Value">--</p>
            </div>
        </div>
        <p class="status" id="statusMessage">請點擊「連接藍牙設備」按鈕。</p>
    </div>

    <script>
        // DOM 元素
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const heartRateValue = document.getElementById('heartRateValue');
        const spo2Value = document.getElementById('spo2Value');
        const statusMessage = document.getElementById('statusMessage');

        // 藍牙服務和特性 UUIDs
        const HEART_RATE_SERVICE_UUID = 'heart_rate';
        const HEART_RATE_MEASUREMENT_CHARACTERISTIC_UUID = 'heart_rate_measurement';
        const SPO2_SERVICE_UUID = '00001825-0000-1000-8000-00805f9b34fb';
        const SPO2_MEASUREMENT_CHARACTERISTIC_UUID = '00002a5f-0000-1000-8000-00805f9b34fb';
        
        // **請將此網址替換為你自己的 Google Apps Script 網頁應用程式網址**
        const WEB_APP_URL = 'https://script.google.com/a/macros/nkust.edu.tw/s/AKfycbwmsx05aVsgtLtJ6tPl2vDJOeBbLFsw00r6P7fteiynPOPypQfm3nQbAOq7i8glfHLO/exec';

        let deviceGATTServer;
        let hrCharacteristic, spo2Characteristic;
        
        // 用於暫存最新的數據
        let latestHeartRate = null;
        let latestSpo2 = null;
        
        let sendDataInterval = null; // 用於儲存計時器

        /**
         * 處理心率測量數據的函數
         * @param {Event} event - characteristicvaluechanged 事件
         */
        function handleHeartRateMeasurement(event) {
            const value = event.target.value; // DataView 物件
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x01;

            let hr = 0;
            if (rate16Bits) {
                hr = value.getUint16(1, true); // 小端序
            } else {
                hr = value.getUint8(1);
            }
            heartRateValue.textContent = hr;
            latestHeartRate = hr; // 更新最新的心率數據
            console.log(`心率: ${hr} BPM`);
        }

        /**
         * 處理血氧測量數據的函數
         * **重要：此為通用範例，請根據你的設備文檔調整解析邏輯！**
         * @param {Event} event - characteristicvaluechanged 事件
         */
        function handleSpo2Measurement(event) {
            const value = event.target.value; // DataView 物件
            
            if (value.byteLength >= 4) {
                const spo2Raw = value.getUint16(2, true); 
                const spo2 = (spo2Raw / 10.0).toFixed(1);
                
                spo2Value.textContent = spo2;
                latestSpo2 = spo2; // 更新最新的血氧數據
                console.log(`血氧: ${spo2}%`);
            } else {
                console.warn('血氧數據格式不符合預期，長度不足。');
                spo2Value.textContent = '解析錯誤';
            }
        }
        
        /**
         * 發送數據到 Google Sheets 的函數
         */
        async function sendDataToSheet() {
            if (latestHeartRate === null || latestSpo2 === null) {
                console.warn('數據不完整，暫不發送。');
                return;
            }

            try {
                const dataToSend = {
                    heartRate: latestHeartRate,
                    spo2: latestSpo2
                };
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });
                console.log('數據已成功發送至 Google Sheets');
            } catch (error) {
                console.error('發送數據到 Google Sheets 失敗:', error);
            }
        }

        /**
         * 處理設備斷開連接的函數
         * @param {Event} event - gattserverdisconnected 事件
         */
        function onDisconnected(event) {
            const device = event.target;
            console.log(`設備 ${device.name || '未知設備'} 已斷開連接.`);

            statusMessage.textContent = `設備 ${device.name || '未知設備'} 已斷開連接。`;
            heartRateValue.textContent = '--';
            spo2Value.textContent = '--';
            
            // 停止定時發送數據
            clearInterval(sendDataInterval);
            
            // 停止通知監聽
            if (hrCharacteristic) hrCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
            if (spo2Characteristic) spo2Characteristic.removeEventListener('characteristicvaluechanged', handleSpo2Measurement);

            updateButtonState(false);
        }

        /**
         * 連接藍牙設備的處理函數
         */
        async function connectDevice() {
            statusMessage.textContent = '正在掃描藍牙設備...';
            updateButtonState(true);

            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [HEART_RATE_SERVICE_UUID] }],
                    optionalServices: [SPO2_SERVICE_UUID]
                });
                
                statusMessage.textContent = `已找到設備：${device.name || '未知設備'}`;
                
                device.addEventListener('gattserverdisconnected', onDisconnected);
                deviceGATTServer = await device.gatt.connect();
                statusMessage.textContent = '已連接到 GATT 服務。';
                
                const hrService = await deviceGATTServer.getPrimaryService(HEART_RATE_SERVICE_UUID);
                hrCharacteristic = await hrService.getCharacteristic(HEART_RATE_MEASUREMENT_CHARACTERISTIC_UUID);
                await hrCharacteristic.startNotifications();
                hrCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
                
                try {
                    const spo2Service = await deviceGATTServer.getPrimaryService(SPO2_SERVICE_UUID);
                    spo2Characteristic = await spo2Service.getCharacteristic(SPO2_MEASUREMENT_CHARACTERISTIC_UUID);
                    await spo2Characteristic.startNotifications();
                    spo2Characteristic.addEventListener('characteristicvaluechanged', handleSpo2Measurement);
                    statusMessage.textContent = '已成功連接並監測心率與血氧。';
                } catch (error) {
                    console.warn('此設備不支援標準血氧服務或找不到血氧特性。', error);
                    statusMessage.textContent = '已成功連接並監測心率。此設備可能不支援血氧監測。';
                    spo2Value.textContent = 'N/A';
                }
                
                // 連接成功後，每隔 10 秒發送一次數據到 Google Sheets
                sendDataInterval = setInterval(sendDataToSheet, 10000);

            } catch (error) {
                statusMessage.textContent = `連接失敗：${error.message}`;
                console.error('藍牙連接錯誤:', error);
                updateButtonState(false);
            }
        }

        /**
         * 斷開藍牙連接的處理函數
         */
        function disconnectDevice() {
            if (deviceGATTServer && deviceGATTServer.connected) {
                deviceGATTServer.disconnect();
            } else {
                statusMessage.textContent = '沒有已連接的藍牙設備。';
                updateButtonState(false);
            }
        }
        
        /**
         * 更新按鈕狀態的函數
         * @param {boolean} isConnected - 是否已連接
         */
        function updateButtonState(isConnected) {
            connectButton.disabled = isConnected;
            disconnectButton.disabled = !isConnected;
        }

        // 綁定事件監聽器
        connectButton.addEventListener('click', connectDevice);
        disconnectButton.addEventListener('click', disconnectDevice);
    </script>
</body>
</html>

